<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Image Loader</title>
    <style>        
      body {
        margin: 0;
        font-family: Arial;
        overflow: scroll;
        max-width: 1088px;
        height: 100%;
        background-repeat: no-repeat;
        background-attachment: fixed;
        margin: auto;
        overflow: scroll;
        background: linear-gradient(to top, #007028, #72b348)fixed;
        overflow-x: hidden;     
    }
    @keyframes fadein {
    from { opacity: 0; }
    to   { opacity: 1; }
    }
    </style>
    <script type="text/javascript">
        const state = [];
        const history = [];

        function load(index) {
            console.log(`index: ${index}`);
            setTimeout(function () {
                if (index >= 0) {
                    var img = new Image();         
                    img.style = "animation: fadein 1s ease-in-out;"           
                    var selected = state[index];                    
                    console.log(`Selected:${selected}`);
                    console.log(`SCount:${state.length}-State:${JSON.stringify(state)}`);
                    console.log(`HCount: ${history.length}-History:${JSON.stringify(history)}`)

                    img.src = `https://nzart.app/api/downloader?prompt=${selected.PromptText}&seed=${selected.Seeds[0]}`;
                    //if image isn't in container add it, otherwise replace it
                    if (document.getElementById("container").children.length > 0) {
                        document.getElementById("container").replaceChild(img, document.getElementById("container").children[0]);
                    } else {
                        document.getElementById("container").appendChild(img);
                    }

                    history.push(selected);
                    state.splice(index, 1);

                    load(index - 1);
                }
                if (state.length == 0) {
                    //new event type of finishedRender
                    var event = new Event('finishedRender');
                    document.dispatchEvent(event);
                    console.log("Displayed all fetched images, requesting more");
                }
            }, 7000);
        }

        document.addEventListener('finishedRender', function (e) {
            console.log("Finished rendering, requesting more");
            fetchPrompts();
        });

        function fetchPrompts() {
            fetch("https://nzart.app/api/queue-fetcher?code=RNCJOcxB66TXjTvtRGP8FJ9ZiLriakVw9ev09azhcNTMAzFu5a6hfg==").then(function (response) {
                return response.json();
            }).then(function (data) {
                console.log(data);
                var qMessages = data.QueueMessagesList?.QueueMessage;
                if (qMessages != undefined) {
                    //check type of qMessages
                    if (Array.isArray(qMessages)) {
                        //iterate through qMessages
                        for (var i = 0; i < qMessages.length; i++) {
                            var element = qMessages[i];
                            //base64 decode the message
                            var decoded = atob(element.MessageText);
                            //parse the json
                            var json = JSON.parse(decoded);
                            //only add to state if the prompt value does not exist in history
                            if (history.filter(x => x.PromptText == json.PromptText).length == 0) {                               
                                console.log(`Prompt:${json.PromptText} does not exist in history, adding to state`);
                                state.push(json);                                
                            }
                        }
                        console.log(`Loaded ${state.length} items into state`);

                        load(state.length - 1);

                    } else {
                        var decoded = atob(qMessages.MessageText);
                        var json = JSON.parse(decoded);
                        if (history.filter(x => x.PromptText == json.PromptText).length == 0) {                                
                            console.log(`Prompt:${json.PromptText} does not exist in history, adding to state`);
                            state.push(json);                            
                        }
                        //There's only one entry, qMessages is not an array, so just load it
                        load(0);
                    }
                }
            });
        }
    </script>
</head>

<body onload="fetchPrompts()" id="container">
    <label>Loading...</label>
    <div id="promptText" id="prompt"></div>
</body>

</html>